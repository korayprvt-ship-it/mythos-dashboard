<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        /* Header */
        .header {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            margin-top: 10px;
        }

        /* Session Timer */
        .session-timer {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(255, 0, 0, 0.2);
            padding: 15px 25px;
            border-radius: 15px;
            border: 2px solid rgba(255, 0, 0, 0.5);
            z-index: 1000;
        }

        .timer-countdown {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ff6b6b;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .tab:hover { background: rgba(255, 255, 255, 0.2); }
        .tab.active {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            font-weight: 700;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .card-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Stat Box */
        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label { margin-top: 10px; opacity: 0.8; }

        /* Player List */
        .player-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-info { display: flex; gap: 15px; align-items: center; }

        .rank-badge {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .rank-king { background: linear-gradient(45deg, #ffd700, #ffed4e); color: #000; }
        .rank-general { background: linear-gradient(45deg, #4ecdc4, #44a3a0); }
        .rank-normal { background: rgba(255, 255, 255, 0.2); }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary { background: linear-gradient(45deg, #4ecdc4, #44a3a0); color: #fff; }
        .btn-danger { background: linear-gradient(45deg, #ff6b6b, #ee5a6f); color: #fff; }
        .btn-warning { background: linear-gradient(45deg, #ffd93d, #ffaa00); color: #000; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.3); }

        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
        }
        .form-textarea { min-height: 100px; resize: vertical; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px; right: 30px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 30px;
            border-radius: 10px;
            border-left: 5px solid #4ecdc4;
            z-index: 9999;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        .toast.success { border-left-color: #4ecdc4; }
        .toast.error { border-left-color: #ff6b6b; }

        .hidden { display: none !important; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.5rem;
        }
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid #ffd700;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <div>Dashboard l√§dt...</div>
    </div>

    <!-- Session Timer -->
    <div class="session-timer hidden" id="sessionTimer">
        <div style="font-size: 0.9rem; opacity: 0.8;">‚è∞ Session</div>
        <div class="timer-countdown" id="countdown">--:--</div>
    </div>

    <!-- Main Dashboard -->
    <div class="container hidden" id="mainContent">
        <div class="header">
            <h1>‚öîÔ∏è KINGDOM ADMIN DASHBOARD ‚öîÔ∏è</h1>
            <div class="admin-badge">üëë Administrator</div>
            <div style="margin-top: 15px; opacity: 0.8;" id="playerInfo">Angemeldet als: ...</div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')">üìä √úbersicht</div>
            <div class="tab" onclick="switchTab('players')">üë• Spieler</div>
            <div class="tab" onclick="switchTab('kingdoms')">üè∞ Kingdoms</div>
            <div class="tab" onclick="switchTab('admin')">‚öôÔ∏è Administration</div>
        </div>

        <!-- Overview Tab -->
        <div id="overviewTab" class="tab-content">
            <div class="card">
                <h2 class="card-title">üìä Server Statistiken</h2>
                <div class="grid" id="statsGrid">
                    <div class="stat-box">
                        <div class="stat-number" id="onlinePlayers">0</div>
                        <div class="stat-label">Online Spieler</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="totalKings">0</div>
                        <div class="stat-label">K√∂nige</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="totalGenerals">0</div>
                        <div class="stat-label">Gener√§le</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="activeCombats">0</div>
                        <div class="stat-label">Aktive K√§mpfe</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">‚öîÔ∏è Aktive K√§mpfe</h2>
                <div id="combatList"></div>
            </div>
        </div>

        <!-- Players Tab -->
        <div id="playersTab" class="tab-content hidden">
            <div class="card">
                <h2 class="card-title">üë• Online Spieler</h2>
                <div id="playersList"></div>
            </div>
        </div>

        <!-- Kingdoms Tab -->
        <div id="kingdomsTab" class="tab-content hidden">
            <div id="kingdomsGrid"></div>
        </div>

        <!-- Admin Tab -->
        <div id="adminTab" class="tab-content hidden">
            <div class="grid">
                <div class="card">
                    <h3 class="card-title">üì¢ Broadcast</h3>
                    <div class="form-group">
                        <label class="form-label">Nachricht</label>
                        <textarea id="broadcastMsg" class="form-textarea" placeholder="Deine Nachricht..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="sendBroadcast()">Senden</button>
                </div>

                <div class="card">
                    <h3 class="card-title">üë¢ Spieler Kicken</h3>
                    <div class="form-group">
                        <label class="form-label">Spielername</label>
                        <input type="text" id="kickPlayer" class="form-input" placeholder="Spielername">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grund</label>
                        <input type="text" id="kickReason" class="form-input" placeholder="Grund..." value="Dashboard Kick">
                    </div>
                    <button class="btn btn-danger" onclick="kickPlayer()">Kicken</button>
                </div>

                <div class="card">
                    <h3 class="card-title">üëë Rang Setzen</h3>
                    <div class="form-group">
                        <label class="form-label">Spielername</label>
                        <input type="text" id="rankPlayer" class="form-input" placeholder="Spielername">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rang</label>
                        <select id="rankSelect" class="form-select">
                            <option value="normal">Normal</option>
                            <option value="general">General</option>
                            <option value="king">K√∂nig</option>
                        </select>
                    </div>
                    <button class="btn btn-warning" onclick="setRank()">Setzen</button>
                </div>

                <div class="card">
                    <h3 class="card-title">‚ö° Console Command</h3>
                    <div class="form-group">
                        <label class="form-label">Befehl (ohne /)</label>
                        <input type="text" id="customCmd" class="form-input" placeholder="z.B. gamemode creative Steve">
                    </div>
                    <button class="btn btn-primary" onclick="executeCommand()">Ausf√ºhren</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let API_URL = '';
        let sessionToken = null;
        let sessionRemaining = 0;
        let currentTab = 'overview';
        let refreshInterval = null;

        // ‚úÖ Automatische Initialisierung beim Laden
        window.addEventListener('DOMContentLoaded', async () => {
            // Token aus URL holen
            const params = new URLSearchParams(window.location.search);
            sessionToken = params.get('token');
            
            // API URL aus der aktuellen Seiten-URL ableiten
            API_URL = window.location.origin + '/api';
            
            console.log('üîÑ Dashboard l√§dt...');
            console.log('üì° API URL:', API_URL);
            console.log('üîë Token:', sessionToken ? '‚úÖ Vorhanden' : '‚ùå Fehlt');

            if (!sessionToken) {
                document.getElementById('loadingScreen').innerHTML = `
                    <div style="background:rgba(255,0,0,0.2);padding:40px;border-radius:20px;border:2px solid #ff6b6b;">
                        <div style="font-size:3rem;margin-bottom:20px;">‚ö†Ô∏è</div>
                        <div style="font-size:1.5rem;margin-bottom:10px;">Kein Token gefunden!</div>
                        <div style="opacity:0.8;">Bitte benutze <strong>/myredashboard</strong> im Spiel um einen Link zu erhalten.</div>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${API_URL}/validate?token=${sessionToken}`);
                const data = await response.json();
                
                if (!data.valid) {
                    throw new Error('Token ung√ºltig oder abgelaufen');
                }

                if (!data.isAdmin) {
                    throw new Error('Keine Admin-Berechtigung');
                }
                
                sessionRemaining = data.remaining;
                document.getElementById('playerInfo').textContent = `Angemeldet als: ${data.player}`;
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('sessionTimer').classList.remove('hidden');
                
                startTimer();
                refreshAll();
                refreshInterval = setInterval(refreshAll, 3000);

                console.log('‚úÖ Dashboard erfolgreich geladen!');

            } catch (error) {
                console.error('‚ùå Fehler:', error);
                document.getElementById('loadingScreen').innerHTML = `
                    <div style="background:rgba(255,0,0,0.2);padding:40px;border-radius:20px;border:2px solid #ff6b6b;">
                        <div style="font-size:3rem;margin-bottom:20px;">‚ùå</div>
                        <div style="font-size:1.5rem;margin-bottom:10px;">Verbindungsfehler</div>
                        <div style="opacity:0.8;">${error.message}</div>
                        <div style="margin-top:20px;font-size:0.9rem;opacity:0.7;">
                            Stelle sicher dass der Minecraft Server l√§uft und Port 25580 erreichbar ist.
                        </div>
                    </div>
                `;
            }
        });

        function startTimer() {
            setInterval(() => {
                sessionRemaining--;
                const mins = Math.floor(sessionRemaining / 60);
                const secs = sessionRemaining % 60;
                document.getElementById('countdown').textContent = 
                    `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
                
                if (sessionRemaining <= 0) {
                    clearInterval(refreshInterval);
                    alert('Session abgelaufen! Bitte neu einloggen mit /myredashboard');
                    location.reload();
                }
            }, 1000);
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            
            if (tab === 'players') loadPlayers();
            if (tab === 'kingdoms') loadKingdoms();
        }

        async function refreshAll() {
            await loadStats();
            await loadCombat();
            if (currentTab === 'players') await loadPlayers();
            if (currentTab === 'kingdoms') await loadKingdoms();
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats?token=${sessionToken}`);
                const data = await response.json();
                
                let totalKings = 0, totalGenerals = 0;
                for (let i = 1; i <= 6; i++) {
                    const k = data.kingdoms[`kingdom_${i}`];
                    totalKings += k.kings;
                    totalGenerals += k.generals;
                }
                
                document.getElementById('onlinePlayers').textContent = data.onlinePlayers;
                document.getElementById('totalKings').textContent = totalKings;
                document.getElementById('totalGenerals').textContent = totalGenerals;
            } catch (error) {
                console.error('Stats Error:', error);
            }
        }

        async function loadCombat() {
            try {
                const response = await fetch(`${API_URL}/combat?token=${sessionToken}`);
                const data = await response.json();
                
                document.getElementById('activeCombats').textContent = data.length;
                
                const list = document.getElementById('combatList');
                if (data.length === 0) {
                    list.innerHTML = '<p style="opacity:0.6;text-align:center;">Keine aktiven K√§mpfe</p>';
                } else {
                    list.innerHTML = data.map(c => `
                        <div class="player-item">
                            <div>${c.player} vs ${c.enemy || '?'}</div>
                            <div style="color:#ff6b6b;font-weight:700;">${c.timeLeft}s</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Combat Error:', error);
            }
        }

        async function loadPlayers() {
            try {
                const response = await fetch(`${API_URL}/admin/players?token=${sessionToken}`);
                const data = await response.json();
                
                const list = document.getElementById('playersList');
                list.innerHTML = data.map(p => `
                    <div class="player-item">
                        <div class="player-info">
                            <span class="rank-badge rank-${p.rank}">${p.rank === 'king' ? 'üëë' : p.rank === 'general' ? '‚öîÔ∏è' : 'üõ°Ô∏è'}</span>
                            <strong>${p.name}</strong>
                            <span style="opacity:0.7;">Kingdom ${p.kingdom || '?'}</span>
                        </div>
                        <button class="btn btn-danger" onclick="kickPlayerDirect('${p.name}')">Kick</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Players Error:', error);
            }
        }

        async function loadKingdoms() {
            try {
                const response = await fetch(`${API_URL}/kingdoms?token=${sessionToken}`);
                const data = await response.json();
                
                const grid = document.getElementById('kingdomsGrid');
                grid.innerHTML = data.map(k => `
                    <div class="card">
                        <h3 class="card-title">Kingdom ${k.id} (${k.players.length})</h3>
                        ${k.players.length === 0 ? '<p style="opacity:0.6;">Keine Spieler</p>' : 
                          k.players.map(p => `
                            <div class="player-item">
                                <div class="player-info">
                                    <span class="rank-badge rank-${p.rank}">${p.rank === 'king' ? 'üëë' : p.rank === 'general' ? '‚öîÔ∏è' : 'üõ°Ô∏è'}</span>
                                    <span>${p.name}</span>
                                </div>
                                <span>‚ù§ ${p.lives}</span>
                            </div>
                          `).join('')
                        }
                    </div>
                `).join('');
            } catch (error) {
                console.error('Kingdoms Error:', error);
            }
        }

        async function sendBroadcast() {
            const msg = document.getElementById('broadcastMsg').value;
            if (!msg) return alert('Nachricht eingeben!');
            
            try {
                const response = await fetch(`${API_URL}/admin/broadcast?token=${sessionToken}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `message=${encodeURIComponent(msg)}`
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('‚úÖ Broadcast gesendet!', 'success');
                    document.getElementById('broadcastMsg').value = '';
                } else {
                    showToast('‚ùå ' + data.error, 'error');
                }
            } catch (error) {
                showToast('‚ùå Verbindungsfehler', 'error');
            }
        }

        async function kickPlayerDirect(playerName) {
            if (!confirm(`${playerName} kicken?`)) return;
            await kickPlayer(playerName);
        }

        async function kickPlayer(playerName) {
            if (!playerName) playerName = document.getElementById('kickPlayer').value;
            const reason = document.getElementById('kickReason')?.value || 'Dashboard Kick';
            
            if (!playerName) return alert('Spielername eingeben!');
            
            try {
                const response = await fetch(`${API_URL}/admin/kick?token=${sessionToken}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `player=${encodeURIComponent(playerName)}&reason=${encodeURIComponent(reason)}`
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('‚úÖ Spieler gekickt!', 'success');
                    if (document.getElementById('kickPlayer')) document.getElementById('kickPlayer').value = '';
                    loadPlayers();
                } else {
                    showToast('‚ùå ' + data.error, 'error');
                }
            } catch (error) {
                showToast('‚ùå Verbindungsfehler', 'error');
            }
        }

        async function setRank() {
            const player = document.getElementById('rankPlayer').value;
            const rank = document.getElementById('rankSelect').value;
            
            if (!player) return alert('Spielername eingeben!');
            if (!confirm(`${player} zu ${rank} machen?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/admin/setrank?token=${sessionToken}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `player=${encodeURIComponent(player)}&rank=${rank}`
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('‚úÖ Rang ge√§ndert!', 'success');
                    document.getElementById('rankPlayer').value = '';
                } else {
                    showToast('‚ùå ' + data.error, 'error');
                }
            } catch (error) {
                showToast('‚ùå Verbindungsfehler', 'error');
            }
        }

        async function executeCommand() {
            const cmd = document.getElementById('customCmd').value;
            if (!cmd) return alert('Befehl eingeben!');
            if (!confirm(`Command ausf√ºhren: /${cmd}`)) return;
            
            try {
                const response = await fetch(`${API_URL}/admin/command?token=${sessionToken}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `command=${encodeURIComponent(cmd)}`
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('‚úÖ Command ausgef√ºhrt!', 'success');
                    document.getElementById('customCmd').value = '';
                } else {
                    showToast('‚ùå ' + data.error, 'error');
                }
            } catch (error) {
                showToast('‚ùå Verbindungsfehler', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
